<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="./lib/epub.js/dist/epub.js"></script>
        <script type="text/javascript" src="./lib/jszip.min.js"></script>
        <script type="text/javascript">
            const {ipcRenderer} = require("electron");
            
            ipcRenderer.on("find", (event, data) => {
                let results = [];
                const {bookPath, query} = data;
                const Book = ePub(bookPath);

                const requestFromArchive = function(url) {
                    const archive = Book.archive;
                    return archive.request(url);
                };

                Book.ready.then(() => {
                    const sections = Book.spine.items.map(section => Book.section(section.index));
                    for (let i = 0; i < sections.length; i++) {
                        const section = sections[i];
                        section.load(requestFromArchive).then(() => {
                            const sectionResults = section.find(query);
                            results = results.concat(sectionResults);
                            if (i == sections.length - 1) {
                                ipcRenderer.send('findResults', results);
                            }
                        });
                    }
                });
            });
        </script>
    </head>
</html>
